---
rip: 7712
title: 2차원 논스를 사용하는 RIP-7560 트랜잭션 활성화
description: 스마트 컨트랙트 계정이 자체 트랜잭션 시퀀싱을 정의할 수 있게 하는 RIP-7560 트랜잭션 수정
author: Vitalik Buterin (@vbuterin), Yoav Weiss (@yoavw), Alex Forshtat (@forshtat), Dror Tirosh (@drortirosh), Shahaf Nacson (@shahafn)
discussions-to: https://ethereum-magicians.org/t/rip-7712-multi-dimensional-256-bit-nonce-for-rip-7560-account-abstraction-transactions/20094
status: Draft
type: Standards Track
category: Core
created: 2023-09-01
requires: 7560
---

## 개요

기존 논스 기반 시퀀싱 메커니즘을 온체인 사전 배포 컨트랙트로 대체하여 스마트 컨트랙트 계정에게 일부 고급 사용 사례를 지원하는 데 필요한 유연성을 제공하는 RIP-7560 트랜잭션 수정입니다.

## 동기

전통적인 논스 기반 시스템은 트랜잭션 순서 보장과 재생 보호를 제공하지만, 구성 가능성을 희생합니다.
계정은 "이 세 트랜잭션을 어떤 순서로든 마이닝되도록 허용" 또는 "이 두 트랜잭션 집합은 별도의 순차 논스를 가져야 함"과 같은 의도를 표현할 수 없습니다.

그러나 스마트 컨트랙트 계정에서 이는 일부 사용 사례의 병목 현상을 만듭니다.
예를 들어, 여러 참가자가 동시에 운영하도록 설계된 스마트 컨트랙트 계정은 이러한 참가자가 서로의 트랜잭션을 무효화하지 않도록 조정해야 합니다.

이것이 제한이 될 수 있는 또 다른 예는 별도의 실행 흐름이 있는 경우입니다.
구성 변경은 여러 참가자가 트랜잭션에 공동 서명해야 하지만 일반 작업은 그렇지 않습니다.
순차 논스에서는 구성 변경이 실행될 때까지 모든 작업이 중단되어야 합니다.

더 민첩한 순서 지정 및 재생 보호 시스템은 RIP-7560의 사용자 경험을 크게 향상시킵니다.

또한 네이티브 계정 추상화가 ERC-4337과의 기능 동등성 및 호환성을 달성하려면 이 변경이 필요합니다. 모든 ERC-4337 스마트 컨트랙트 계정은 이미 아래 설명된 솔루션을 사용하기 때문입니다.

## 사양

### 상수

| 이름                     | 값    |
|--------------------------|-------|
| AA_BASE_GAS_COST         | 15000 |
| AA_BASE_GAS_COST_RIP7712 | 10000 |
| AA_NONCE_MANAGER         | tbd   |

### 비순차 논스 지원


RIP-7560 트랜잭션의 `nonce` 매개변수에 두 번째 차원을 제공하기 위해 `nonceKey` 매개변수 도입을 제안합니다.

트랜잭션의 2차원 논스 값은 `uint256 nonceKey || uint256 nonceSequence` 값으로 표현됩니다.
그런 다음 컨트랙트 계정 논스는 `address account => uint256 nonceKey => uint256 nonceSequence` 매핑으로 정의됩니다.
이 접근 방식은 고유한 트랜잭션 논스와 해시를 보장하지만 논스가 순차 숫자여야 하는 요구사항을 제거합니다.

이 2차원 논스 메커니즘은 `AA_NONCE_MANAGER` 주소에 위치한 `NonceManager` 사전 배포 컨트랙트에서 EVM에 노출됩니다.

2차원 논스는 나머지 검증 코드 전에 `AA_TX_TYPE` 트랜잭션 검증의 일부로 온체인에서 [검증 및 증가](#논스-검증-프레임)됩니다.

### 논스 검증

RIP-7560 트랜잭션 검증 흐름에 새로운 검증 프레임을 도입할 것을 제안합니다.
이 검증 프레임은 온체인 논스 검증을 수행하며 트랜잭션의 다른 모든 프레임 전에 실행됩니다.

nonceKey가 0(존재하지 않음)이면 논스 필드가 시스템 논스와 비교된 다음 시스템 논스가 증가합니다.
트랜잭션의 기본 비용은 `A_BASE_GAS_COST`입니다.

`nonceKey`가 0이 아니면 `NonceManager`가 호출되어 이 키에 대한 논스를 [검증하고 증가](#논스-검증-프레임)시키며, 기본 비용은 `NonceManager` 프레임이 별도로 지불되므로 `AA_BASE_GAS_COST_RIP7712`입니다.
이 경우 이전 시스템 `nonce`는 확인되지 않고 증가되지 않습니다.

### 배포 트랜잭션

계정 배포 트랜잭션 중에 `nonceKey`는 반드시 0이어야 합니다(MUST).
이전 시스템 `nonce` 매개변수는 트랜잭션 전에 증가되지 않습니다:
배포자가 사용하는 `CREATE` 또는 `CREATE2` 옵코드가 [EIP-161](https://eips.ethereum.org/EIPS/eip-161)에 따라 논스를 1로 증가시킵니다.

### 레거시 `nonce` 계정 매개변수 사용

레거시 64비트 `nonce` 계정 매개변수는 `AA_TX_TYPE` 트랜잭션의 `nonceKey` 매개변수가 0으로 설정될 때 사용됩니다.

레거시 `nonce` 계정 매개변수는 EOA가 시작한 트랜잭션, `CREATE` 옵코드 및 EIP-7702 인증에도 사용됩니다.

### 계정 배포 트랜잭션은 레거시 `nonce`를 증가시키지 않음

`sender` 계정을 생성하기 위해 `deployer` 및 `deployerData` 필드를 포함하는 첫 번째 `AA_TX_TYPE` 트랜잭션은 `key` 매개변수가 0으로 설정된 경우에도 `sender`의 레거시 `nonce` 계정 매개변수를 증가시키지 않습니다.

#### 논스 검증 프레임

검증 단계에서 첫 번째 RIP-7560 트랜잭션 타입 정의 검증 프레임이 적용되기 전에, `NonceManager`가 다음 데이터로 호출됩니다:

```
sender{20 bytes} nonceKey{32 bytes} nonceSequence{32 bytes}
```

이 검증 프레임의 가스 비용은 트랜잭션 총계에 포함되며, 계정의 `validationGasLimit`에서 차감됩니다.

#### 논스 쿼리 프레임

주어진 `nonceKey`에 대한 현재 `nonceSequence`를 쿼리하기 위해 사용자는 다음 데이터로 `NonceManager` 컨트랙트에 뷰 호출을 수행합니다:

```
sender{20 bytes} nonceKey{32 bytes}
```

이 호출의 반환 값은 [논스 검증 프레임](#논스-검증-프레임)에서 사용할 수 있는 현재 `nonceSequence`입니다.

#### NonceManager 의사 코드

```
if evm.caller == AA_ENTRY_POINT:
    validate_increment()
else:
    get()
def get():
    if len(evm.calldata) != 52:
        evm.revert()
    // address sender, 256 bit nonce key
    address = to_uint160_be(evm.calldata[0:20])
    key = to_uint256_be(evm.calldata[20:52])
    nonce = storage.get(keccak(address, key))
    evm.return(nonce)
def validate_increment():
    address = to_uint256_be(evm.calldata[0:20])
    key = to_uint256_be(evm.calldata[20:52])
    nonce = to_uint256_be(evm.calldata[52:84])
    current_nonce = storage.get(keccak(address, key))
    if (nonce != current_nonce):
        evm.revert()
    storage.set(keccak(address, key), current_nonce + 1)
```

#### NonceManager 바이트코드 및 배포

TODO.

## 근거

### 계정 데이터 구조 수정 대신 사전 배포 컨트랙트 생성

두 옵션 모두 기술적 이점이 없지만, EVM 코드가 논스를 제어하도록 허용하는 것이 이더리움 프로토콜에 대한 더 작은 변경으로 보이며 계정 추상화 비전에 더 부합합니다.

### 계정 배포 트랜잭션은 레거시 `nonce`를 증가시키지 않음

[EIP-684](https://eips.ethereum.org/EIPS/eip-684)는 논스 값이 0이 아닌 계정에 대한 컨트랙트 배포를 명시적으로 방지합니다. 이 규칙은 트랜잭션 실행이 시작되기 전에 `sender` 논스를 증가시키는 일반적인 흐름과 충돌합니다.
그러나 [EIP-161](https://eips.ethereum.org/EIPS/eip-161)은 새로 생성된 계정의 `nonce`가 생성 시 `1`로 설정됨을 보장합니다.

이는 `sender` 배포 트랜잭션이 EIP-684 규칙 검사를 통과하고 여전히 논스를 증가시킬 수 있음을 보장합니다.

생성 프레임에서 되돌림은 `AA_TX_TYPE` 트랜잭션을 무효로 만들고 `sender`의 논스는 코드를 성공적으로 배포하지 않고는 증가될 수 없습니다.

## 하위 호환성

실제 `nonce` 값이 EVM 내부에서 관찰 가능한 적이 없었으므로 다른 논스 메커니즘으로의 마이그레이션으로 인한 주요 복잡성은 없어야 합니다.


애플리케이션은 `eth_getTransactionCount` 메서드가 계정의 총 트랜잭션을 반환한다고 가정해서는 안 됩니다.

### 논스 증가를 통한 EIP-7702 인증 취소

EIP-7702에서 EOA는 온체인에 포함되지 않은 한 이전에 서명한 "인증 튜플"을 취소할 수 있습니다.
이는 EOA의 `nonce`를 증가시킴으로써 수행할 수 있으며, 이는 새 트랜잭션을 보내야만 수행할 수 있습니다.
그러나 RIP-7712에서는 레거시 `nonce` 필드에 영향을 주지 않고 트랜잭션을 보내는 새로운 방법이 있습니다.
이러한 트랜잭션은 이전에 서명된 "인증 튜플"도 무효화하지 않습니다.
이 변경 사항을 인식하지 못하는 사용자는 다른 트랜잭션을 보낸 후에도 "인증 튜플"이 유효하게 유지될 것을 예상하지 못할 수 있으며 RIP-7712 및 다차원 논스의 존재를 인식해야 합니다.

## 보안 고려사항

트랜잭션 실행 순서를 강제해야 하는 스마트 컨트랙트 계정은 `nonceKey` 값에 적절한 제한을 적용해야 합니다.

온체인에서 증분 순차 `nonce` 동작을 요구하려면 컨트랙트는 `require(nonceKey == 0)`을 선택할 수 있습니다.

## 저작권

저작권 및 관련 권리는 [CC0](../LICENSE.md)를 통해 포기되었습니다.
