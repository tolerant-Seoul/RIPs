---
rip: 7696
title: 일반 DSM(이중 스칼라 곱셈)을 위한 프리컴파일
description: 임의의 타원 곡선에서 두 점 곱셈과 덧셈을 수행하는 프리컴파일 컨트랙트 추가 제안
author: Renaud Dubois (@rdubois-crypto)
discussions-to: https://ethereum-magicians.org/t/rip7696-generic-double-scalar-multiplication-dsm-for-all-curves/19798
status: Draft
type: Standards Track
category: Core
created: 2024-03-22
---

## 개요

이 제안은 곡선 매개변수 `p`, `a`, `b`, 점 P와 Q의 좌표 `Px1`, `Py1` 및 `Qx2`, `Qy2`, 두 스칼라 `u`, `v`가 주어지면 임의의 타원 곡선에서 두 점 곱셈과 합을 수행하는 두 개의 프리컴파일 컨트랙트를 생성합니다. 따라서 주어진 모든 바이어슈트라스 곡선에서 uP+vQ 값을 계산합니다. 프리컴파일 중 하나는 임의의 곡선에 대해 상당한 속도 향상을 가능하게 하는 추가 데이터(512비트)를 제공합니다. 이 추가 데이터는 점 $P_{128}=2^{128}P$ 및 $Q_{128}=2^{128}Q$로 구성됩니다.


## 동기

계정 추상화(EIP 4337, EIP7560)는 EOA를 비네이티브 서명 알고리즘으로 대체할 수 있게 합니다. RIP7212는 P256에만 초점을 맞추지만, ZK 증명 시스템, 하드웨어 통합 또는 크로스체인 요구사항의 최신 발전에 따라 변경될 수 있는 관심 있는 다른 많은 타원 곡선이 있습니다. 이 프리컴파일은 스텔스, WebAuthn, Schnorr 서명 및 다른 L2와의 저렴한 브릿지와 같은 많은 목표를 달성할 수 있습니다. 오늘날 대부분의 인증 체계는 ECDSA에 의존하지만 Schnorr 버전은 더 MPC 및 ZK 친화적입니다(더 빠르고 안전함). 오늘날 추가 해시가 주어지면 `ecrecover()` 옵코드를 조정하여 스칼라 곱셈을 수행할 수 있습니다. 계정 추상화와 함께 일반 곱셈을 추가하면 많은 저렴하고 강력한 사용 사례의 문이 열립니다. 다음은 사용 사례의 비완전한 목록입니다:


1. **ed25519:** Apple 보안 엔클레이브, Webauthn, OpenSSL, Farcaster, Cosmos, Solana 생태계와의 브릿지.

2. **secp256r1:** 이전 사용 사례 대부분에 더해 Android Keystore, Passkeys.

3. **bn254-G1:** Zcash, Tornado Cash, EIP1962에서 지정됨.


4. **BabyJujub:** Circom 증명 시스템 호환성.

5. **Stark 곡선:** Starknet 생태계.

6. **기타 곡선:** 내부 인자 구성을 위한 Pasta, Vela, sec256q1.


이 제안은 키 관리를 위한 최대 보안과 암호화 민첩성 달성을 목표로 합니다.
일반 MSM(EIP2537에서 제안했지만 BLS12381에 국한되지 않음)이 우수하겠지만, 가능한 트레이드오프의 가변 길이와 복잡성이 수락 확률을 줄이는 것 같습니다. MSM은 주로 ZK 용도를 대상으로 하지만, 페어링 기반이 아닌 고전적인 암호화에서는 DSM이 핵심 필수 작업입니다.

## 사양

### 상수

### 새로운 프리컴파일
=======
| 이름                  | 값     |
|-----------------------|--------|
| FORK_BLOCK            |  TBD   |
| PRECOMPILED_ADDRESS   |  TBD   |
| ECMULMULADD_COST      |  3500  |
| ECMULMULADD_B4_COST   |  2000  |

### 새로운 프리컴파일

#### 타원 곡선 정보

모든 타원 곡선은 방정식 $y^2 ≡ x^3 + ax + b \mod p$로 정의되는 바이어슈트라스 형식으로 표현할 수 있습니다. ecmulmuladd에 필요한 도메인 매개변수의 최소 정보는 다음 방정식과 도메인 매개변수로 정의됩니다:

|  이름  | 값                                                    |
|--------|-------------------------------------------------------|
|  p     |  타원 소수 필드의 모듈러스                             |
|  a     |  타원 곡선 짧은 바이어슈트라스 첫 번째 계수            |
|  b     |  타원 곡선 짧은 바이어슈트라스 두 번째 계수            |

### 검증 시 필수 검사

프리컴파일 컨트랙트는 서명 구성요소가 유효한지 확인하기 위해 다음 요구사항을 **반드시** 검사해야 합니다:


- P와 Q 좌표가 곡선 방정식을 만족하는지
- P와 Q 좌표가 소수 필드 범위 내에 있는지(즉 [0..p-1]에 속하는지)

다음 요소는 프리컴파일에서 검사하지 않습니다:

- 제공된 곡선이 고전적인 기준(트위스트 보안, 임베디드 차수, rho 보안 등)에 대해 안전한지
- 제공된 점이 올바른 서브그룹에 속하는지(비소수 차수 곡선의 경우)


따라서 이전 기준에 대한 확장된 지식과 검토 없이 사용자 정의 곡선을 피하는 것이 강력히 권장됩니다.

### 프리컴파일 컨트랙트 사양


#### ecMulmuladd

`ecMulmuladd` 프리컴파일 컨트랙트는 다음 입력 및 출력으로 제안됩니다(빅엔디안 값):

- **입력 데이터:** 다음을 포함하는 224바이트 데이터:
    - 곡선 소수 필드의 모듈러스 `p` 32바이트
    - 곡선의 첫 번째 계수 `a` 32바이트
    - 곡선의 두 번째 계수 `b` 32바이트
    - 첫 번째 점의 x 좌표 `Px` 32바이트
    - 첫 번째 점의 y 좌표 `Py` 32바이트
    - 첫 번째 점의 x 좌표 `Qx` 32바이트
    - 첫 번째 점의 y 좌표 `Qy` 32바이트
    - P와 곱할 첫 번째 스칼라 `u` 32바이트
    - Q와 곱할 두 번째 스칼라 `v` 32바이트

- **출력 데이터:** 64바이트의 결과 데이터 및 오류
    - ecmulmuladd 프로세스가 성공하면 결과 점을 64바이트 데이터로 반환합니다. 무한 점(덧셈 법칙의 중립)은 (0,0) 쌍으로 표현됩니다.
    - 실패 시 빈 체인을 반환합니다

#### ecMulmuladdB4

`ecMulmuladd_b4` 프리컴파일 컨트랙트는 다음 입력 및 출력으로 제안됩니다(빅엔디안 값):

- **입력 데이터:** 다음을 포함하는 416바이트 데이터:
    - 모듈러스 $p$ 32바이트
    - 서명의 `a` 구성요소 32바이트
    - 서명의 `b` 구성요소 32바이트
    - 첫 번째 점 P의 x 좌표 `Px` 32바이트
    - 첫 번째 점 Q의 y 좌표 `Py` 32바이트
    - 점 $P_{128}=2^{128}P$의 x 좌표 `P128x` 32바이트
    - 점 $P_{128}=2^{128}P$의 y 좌표 `P128y` 32바이트
    - 두 번째 점 Q의 x 좌표 `Qx` 32바이트
    - 두 번째 점 Q의 y 좌표 `Qy` 32바이트
    - 점 $Q_{128}=2^{128}Q$의 x 좌표 `Q128x` 32바이트
    - 점 $Q_{128}=2^{128}Q$의 y 좌표 `Q128y` 32바이트
    - P와 곱할 첫 번째 스칼라 `u` 32바이트
    - Q와 곱할 두 번째 스칼라 `v` 32바이트

- **출력 데이터:** 64바이트의 결과 데이터 및 오류
    - ecmulmuladd 프로세스가 성공하면 결과 점을 64바이트 데이터로 반환합니다. 무한 점(덧셈 법칙의 중립)은 (0,0) 쌍으로 표현됩니다.
    - 실패 시 빈 체인을 반환합니다

### 구현

노드는 적합하다고 판단하는 대로 타원 계산을 구현할 수 있습니다(내부 타원 점 표현, 래더 등의 선택). 성능상의 이유로 소위 Strauss-Shamir 트릭과 함께 몽고메리 곱셈을 사용하는 것이 권장됩니다(ecmulmuladd_b4의 경우 4차원 버전 사용). 윈도잉 및 NAF 사용은 구현 속도를 더욱 높일 수 있습니다. 4차원 버전 사용은 GLV(Gallant-Lambert-Vanstone) 최적화와 동등한 속도 향상을 제공합니다. 차이점은 추가 오프체인 사전 계산이 필요하다는 것입니다.

### 프리컴파일 컨트랙트 가스 사용량

- `ecMulmuladd`의 비용은 `4000` 가스입니다. 이는 일반 곡선에 사용 가능한 최고의 순수 솔리디티 구현에 대한 특수 구현으로의 추가 콜 데이터 비용 증가와 관련이 있으며, 측정에 따르면 10%입니다.

- `ecMulmuladdB4`의 비용은 `2500` 가스입니다. 이는 추가 콜 데이터가 있는 경우와 없는 경우의 ecMulmuladd 구현 가스 비용 비율입니다.

## 하위 호환성

프리컴파일 컨트랙트가 프리컴파일 주소 집합의 다음 사용 가능한 주소인 `PRECOMPILED_ADDRESS`에 추가되므로 하위 호환성 문제는 없습니다.

## 테스트 케이스

## 참조 구현

`ecMulmuladdB4` 프리컴파일 컨트랙트의 구현은 점진적 프리컴파일로 제공됩니다. 현재 비용은 160K입니다.

## 보안 고려사항

변경 사항은 프로토콜 보안에 직접 영향을 미치지 않습니다. 보안은 대상 곡선이 거친 조사 수준과 관련이 있습니다.


## 저작권

저작권 및 관련 권리는 [CC0](../LICENSE.md)를 통해 포기되었습니다.
