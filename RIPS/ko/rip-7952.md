---
rip: 7952
title: 네이티브 계정 추상화 RPC 메서드
description: 트랜잭션 가스 추정 및 스마트 컨트랙트에 대한 뷰 전용 호출과 같은 일반적인 사용자 흐름을 지원하는 네이티브 계정 추상화 특정 RPC 메서드
author: Vitalik Buterin (@vbuterin), Yoav Weiss (@yoavw), Alex Forshtat (@forshtat), Dror Tirosh (@drortirosh), Shahaf Nacson (@shahafn)
discussions-to:
status: Draft
type: Standards Track
category: Core
created: 2025-01-01
requires: 7560
---

## 개요

[RIP-7560](./rip-7560.md)에서 정의된 계정 추상화의 도입으로 여러 기존 RPC API가 필요한 기능을 제공할 수 없게 되었습니다.
필요한 동작 변경이 충분히 중요하여 계정 추상화를 구현하는 이더리움 L2 클라이언트에 완전히 새로운 메서드를 도입해야 합니다.

## 동기

트랜잭션을 생성하는 프로세스는 온체인 프로토콜의 복잡성이 증가함에 따라 점점 더 복잡하고 대화형 프로세스가 되었습니다.
계정 추상화의 도입은 이 복잡성에 새로운 차원을 추가합니다.

AA 트랜잭션은 원자적으로 실행되지만 여러 순차적 프레임으로 구성되므로 AA 트랜잭션의 부분을 개별적으로 안정적으로 준비하는 것이 불가능합니다.

예를 들어, `sender` 스마트 계정의 배포도 수행하는 AA 트랜잭션을 생성할 때 기존 `eth_estimateGas` API를 사용하여 실행 프레임에 대한 가스 추정을 수행하는 것은 거의 불가능합니다.

대신 계정 추상화를 염두에 두고 특별히 설계된 API를 사용해야 합니다.

## 사양

이 문서는 RIP-7560 호환 이더리움 노드가 스마트 지갑 애플리케이션에 제공하는 API를 정의합니다.

### eth_estimateGasAA

AA 트랜잭션의 프레임당 필요한 가스 양을 추정합니다.
RIP-7560 트랜잭션의 각 프레임이 가스 부족 없이 성공적으로 실행되도록 하는 데 필요한 가스 한도 값을 검색합니다.

이 메서드는 레거시 이더리움 `eth_estimateGas` RPC API 메서드와 동등합니다.
이 메서드는 [ERC-7769](https://eips.ethereum.org/EIPS/eip-7769)에 정의된 [ERC-4337](https://eips.ethereum.org/EIPS/eip-4337) UserOperations에 대한 `eth_estimateUserOperationGas` 메서드의 네이티브 AA 동등물이기도 합니다.

검증 프레임의 경우 `acceptAccount`, `acceptPaymaster`, `sigFailAccount` 및 `sigFailPaymaster`와 같은 적절한 `AA_ENTRY_POINT` 콜백에 대한 유효한 호출만 성공으로 간주됩니다.

`eth_esimateGasAA`가 작동하려면 지갑과 페이마스터 모두 RIP-7560에 설명된 대로 서명 검사를 올바르게 구현해야 합니다.\
특히 `senderValidationData` 및 `paymasterData` 필드는 일반적으로 트랜잭션에 대한 서명을 포함하므로 트랜잭션 준비가 완료되기 전에 알 수 없습니다.\
이 문제에 대한 권장 해결책은 지갑이 [제안된 페이마스터 흐름](#제안된-페이마스터-흐름) 섹션에 설명된 대로 이러한 컨트랙트에 대한 **스텁 데이터**를 제공하는 것입니다.

**스텁 데이터**에 대한 서명 검증이 실패하면 검증 코드는 되돌리거나 실행을 완료해서는 안 되며 대신 적절하게 `sigFailAccount` 또는 `sigFailPaymaster` 호출을 할 때까지 평소대로 진행해야 합니다.\
위에서 설명한 것과 같은 적절한 가스 추정 기능을 제공하지 않는 컨트랙트는 `eth_esimateGasAA`가 일관성 없는 결과를 제공하고 검증 프레임의 잘못된 되돌림 위험이 있어 트랜잭션이 무효가 될 수 있습니다.

`eth_esimateGasAA` API는 선택적으로 `State Override Set` 객체를 수락하여 사용자가 가스 추정 중에 상태를 수정할 수 있습니다.
이 필드와 그 동작은 `eth_call` RPC 메서드에 대해 정의된 것과 동등합니다.

프레임에 대한 올바른 가스 한도 값을 찾지 못하면 실패 이유에 대한 자세한 설명과 함께 오류 메시지를 반환합니다.

매개변수:

1. OBJECT - RIP-7560 트랜잭션 객체.
   `validationGasLimit`, `paymasterValidationGasLimit`, `paymasterGasLimit` 및 `callGasLimit` 필드는 선택 사항입니다.
2. QUANTITY | TAG - 정수 블록 번호 또는 "latest", "earliest", "pending", "safe" 또는 "finalized" 문자열
3. OBJECT - `State Override Set`
   `State Override Set` 옵션을 사용하면 호출을 실행하기 전에 컨트랙트의 상태를 변경할 수 있습니다. 이는 실제로 블록체인에서 컨트랙트를 수정하지 않고 해당 호출에 대한 잔액 및 승인과 같은 컨트랙트에 저장된 변수의 값을 수정할 수 있음을 의미합니다.
   이 동작은 `eth_call` RPC 메서드에 대해 정의된 것과 동등합니다.

예시:
```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "eth_estimateGasAA",
  "params": [
    {
      "sender": "0x783Ca0bD27E42357D6Dbc87E9Cf9eb3a8D513843",
      "senderValidationData": "0xdeadbeef",
      "deployer": "0xD6E4aA932147A3FE5311dA1b67D9e73da06F9cEf",
      "deployerData": "0xdeadbeef",
      "paymaster": "0x8410373DF6E9b20765c9599c26d585B2cd0Ef628",
      "paymasterData": "0xdeadbeef",
      "executionData": "0xdeadbeef",
      "builderFee": "0x9184e72a000",
      "maxPriorityFeePerGas": "0x9184e72a000",
      "maxFeePerGas": "0x9184e72a000",
      "accessList": [],
      "authorizationList": [
        {
          "chainId": "0x1",
          "nonce": "0x15",
          "yParity": "0x25",
          "r": "0x1b5e176d927f8e9ab405058b2d2457392da3e20f328b16ddabcebc33eaac5fea",
          "s": "0x4ba69724e8f69de52f0125ad8b3c5c2cef33019bac3249e2c0a2192766d1721c"
        }
      ]
    },
    "latest",
    {
      "0x1111111111111111111111111111111111111111": {
        "balance": "0x9184e72a000",
        "nonce": "0x1",
        "code": "0xdeadbeef",
        "state": {
          "0x0000000000000000000000000000000000000000000000000000000000000001": "0x1"
        },
        "stateDiff": {
          "0x0000000000000000000000000000000000000000000000000000000000000001": "0x1"
        }
      }
    }
  ]
}
```
반환값:

| 이름                        | 타입     | 설명                                                        |
|-----------------------------|----------|-------------------------------------------------------------|
| validationGasLimit          | QUANTITY |                                                             |
| callGasLimit                | QUANTITY |                                                             |
| paymasterValidationGasLimit | QUANTITY | `paymaster`가 설정된 경우, 그렇지 않으면 `null`             |
| paymasterPostOpGasLimit     | QUANTITY | `paymaster`가 설정된 경우, 필요 없으면 `0`, 그렇지 않으면 `null` |

예시:

```json
{
  "validationGasLimit": "0x9184e72a000",
  "paymasterValidationGasLimit":"0x9184e72a000",
  "paymasterPostOpGasLimit":"0x9184e72a000",
  "callGasLimit": "0x9184e72a000"
}
```

### eth_callAA

AA 트랜잭션을 멤풀에 브로드캐스트하거나 블록체인에 커밋하지 않고 메모리에서 실행합니다.
레거시 이더리움 `eth_call` RPC API 메서드와 동등합니다.

입력은 [eth_estimateGasAA](#eth_estimategasaa) 메서드에 대해 정의된 것과 동등합니다.

사용자는 AA 트랜잭션 프레임의 전부 또는 일부에 대한 가스 한도를 제공할 수도 있습니다.\
가스 한도가 제공되지 않으면 RPC 노드 제공자가 기본값을 선택할 수 있습니다.\
RPC 노드 제공자는 블록 가스 한도 및 기본 L2 프로토콜의 기타 규칙을 고려하여 최대 허용 가스 한도 값도 선택해야 합니다.

트랜잭션이 제대로 서명될 필요가 없습니다. 즉, 계정 또는 페이마스터 컨트랙트가 `sigFailAccount` 또는 `sigFailPaymaster` 호출을 한 후에도 실행을 계속합니다.

최상위 실행 프레임에서 반환된 데이터, 가스 사용량 정보 및 RIP-7560 트랜잭션 실행 중에 발생한 이벤트 로그의 전체 배열을 반환합니다.

검증 또는 실행 프레임이 되돌리면 되돌림 메시지를 포함하는 오류 객체를 반환합니다.

입력:

1. OBJECT - RIP-7560 트랜잭션 객체.
   `senderValidationData` 필드는 선택 사항입니다.
2. QUANTITY | TAG - 정수 블록 번호 또는 "latest", "earliest", "pending", "safe" 또는 "finalized" 문자열

반환값:

- **returnData** - DATA - `sender` 실행 프레임의 반환 값
- **gasUsed** - QUANTITY - 트랜잭션에서 사용한 총 가스 양
- **sigFailAccount** - QUANTITY - 계정이 "sigFailAccount"를 호출했는지 여부
- **sigFailPaymaster** - QUANTITY - 페이마스터가 "sigFailPaymaster"를 호출했는지 여부
- **status** - QUANTITY - `paymasterPostOp`을 포함한 실행 단계가 성공적으로 완료되었는지 여부
- **logs** - ARRAY - 트랜잭션 중에 발생한 이벤트 로그 배열

예시:
```json
{
  "returnData": "0xdeadbeef",
  "gasUsed": "0x1a14b",
  "status": "0x1",
  "sigFailAccount":  "0x1",
  "sigFailPaymaster": "0x1",
  "logs": [
    {
      "transactionHash": "0x8fc90a6c3ee3001cdcbbb685b4fbe67b1fa2bec575b15b0395fea5540d0901ae",
      "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
      "blockHash": "0x58a945e1558810523df00490ff28cbe111b37851c44679ce5be1eeaebb4b4907",
      "blockNumber": "0xeb8822",
      "data": "0x000000000000000000000000000000000000000000000000000000001debea42",
      "logIndex": "0x6c",
      "removed": false,
      "topics": [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x0000000000000000000000005067c042e35881843f2b31dfc2db1f4f272ef48c",
        "0x0000000000000000000000003ee18b2214aff97000d974cf647e7c347e8fa585"
      ],
      "transactionIndex": "0x4e"
    }
  ]
}
```

### 제안된 지갑 흐름
지갑은 지갑과 통신하는 dApp이 호출할 수 있도록 `wallet_prepareTransactionAA` 또는 동등한 API를 노출해야 합니다.

`wallet_prepareTransactionAA` API는 L2 클라이언트 RPC 노드 제공자가 아닌 지갑 애플리케이션에서 구현되어야 합니다.

이 메서드는 부분적으로 채워진 RIP-7560 트랜잭션 객체를 받아 누락된 모든 필드를 채웁니다.\
여기에는 가스 가격, 가스 한도, nonce 등이 포함될 수 있습니다.\
모든 매개변수는 선택 사항입니다. 매개변수에 값이 제공되면 이 메서드를 호출해도 이를 재정의하지 않습니다.

이 메서드는 직렬화하여 `eth_sendRawTransaction` API로 보낼 수 있는 전체 트랜잭션 객체를 반환합니다.

지갑이 어떤 이유로든 트랜잭션 객체를 채울 수 없는 경우 `wallet_prepareTransactionAA` 메서드는 적절한 오류 코드를 반환합니다.

### 제안된 페이마스터 흐름

페이마스터 서비스는 [ERC-7677](https://eips.ethereum.org/EIPS/eip-7677)에 정의된 대로 `pm_getPaymasterStubData` 및 `pm_getPaymasterData` API를 노출해야 합니다.

여기에 정의된 API는 L2 클라이언트 RPC 노드 제공자가 아닌 제3자 페이마스터 서비스에서 구현되어야 합니다.

이 API는 `wallet_prepareTransactionAA` 흐름의 일부로 지갑 애플리케이션에서 내부적으로 사용될 것으로 예상됩니다.

### 모든 트랜잭션 수준 RPC API에 계정 추상화 지원 추가

여기에는 다음 API가 포함됩니다:
`eth_sendTransaction`,
`eth_sendRawTransaction`,
`eth_getTransactionByHash`,
`eth_getTransactionReceipt`,
`eth_getTransactionByBlockHashAndIndex`,
`eth_getTransactionByBlockNumberAndIndex`.

이러한 메서드는 매우 유사한 목적을 가지며 새 트랜잭션 타입 객체 반환을 지원해야 합니다.

"트랜잭션 인덱스 위치"는 트랜잭션의 **검증 프레임** 위치에 의해 결정됩니다.

### 오류

오류 형식:

- DATA - 처음 되돌린 프레임의 되돌림 데이터.
- CODE - 온체인에서 되돌림을 일으킨 엔티티를 포함할 수 있는 오류 타입을 나타내는 오류 코드.
- MESSAGE - 가능한 경우 `DATA` 필드의 디코딩을 포함할 수 있는 사람이 읽을 수 있는 오류.

오류 코드:

* code: -32500 - `sender`에 의한 트랜잭션 검증 실패.
  메시지 필드는 `sender`의 되돌림 메시지 및 데이터로 설정되어야 합니다(SHOULD).

* code: -32501 - `paymaster`에 의한 트랜잭션 검증 실패.
  메시지 필드는 `paymaster`의 되돌림 메시지 및 데이터로 설정되어야 합니다(SHOULD).

* code: -32502 - `deployer`에 의한 트랜잭션 검증 실패
  메시지 필드는 `deployer`의 되돌림 메시지 및 데이터로 설정되어야 합니다(SHOULD).

* code: -32503 - 트랜잭션 시간 범위 벗어남.
  메시지 필드에는 요청된 시간 범위와 현재 블록 타임스탬프가 포함되어야 합니다(SHOULD).


## 근거

### 기존 메서드 수정 대신 새 메서드

`eth_esimateGasAA` 및 `eth_callAA` 메서드는 단순히 기존 `eth_esimateGas` 및 `eth_call` 메서드의 RIP-7560 확장이지만, 기존 메서드의 반환 값 타입이 네이티브 계정 추상화 API의 요구사항과 일치하지 않습니다.

새로운 메서드 집합을 만드는 접근 방식은 이러한 메서드가 [EIP-7701](https://eips.ethereum.org/EIPS/eip-7701)에 설명된 EOF 기반 네이티브 계정 추상화에서 나중에 사용될 수 있으므로 장기적으로 더 깔끔합니다.

### `eth_callAA` 반환 데이터 형식

레거시 `eth_call` 메서드는 레거시 트랜잭션의 단일 최상위 호출 프레임의 반환 데이터를 나타내는 단일 DATA 배열을 반환합니다.

그러나 이 접근 방식은 네이티브 계정 추상화 솔루션에 충분히 유용하지 않습니다.\
실행 단계의 최상위 프레임은 여러 내부 배치 호출로 구성될 수 있는 `sender` 스마트 계정에 대한 호출입니다.

또한 `sender` 주소의 코드는 자주 구현의 반환 데이터를 전파하지 않는 프록시 컨트랙트입니다.

스마트 컨트랙트 지갑이 오프체인 실행에 데이터를 안정적으로 노출할 수 있도록 하려면 이벤트 로그를 발생시키는 기존 메커니즘에 의존하는 것 외에는 선택의 여지가 거의 없습니다.

## 하위 호환성

추가된 메서드는 기존 코드를 방해하지 않으며 하위 호환성 문제가 없어야 합니다.

## 보안 고려사항

### 스마트 컨트랙트의 가스 추정 흐름

[eth_estimateGasAA](#eth_estimategasaa) 섹션에서 언급했듯이 `sender` 및 `paymaster` 스마트 컨트랙트는 가스 추정을 지원하기 위해 특수 코드 흐름을 명시적으로 구현해야 합니다.

이 코드는 `eth_estimateGasAA` 중에만 실행 가능해야 하며 유효한 트랜잭션을 절대로 초래해서는 안 됩니다(MUST).
이 제약이 위반되면 컨트랙트는 다양한 잠재적 위협에 취약해집니다.

## 저작권

저작권 및 관련 권리는 [CC0](../LICENSE.md)를 통해 포기되었습니다.
