---
rip: 7212
title: secp256r1 곡선 지원을 위한 프리컴파일
description: "secp256r1" 타원 곡선에서 서명 검증을 수행하는 프리컴파일 컨트랙트 추가 제안
author: Ulaş Erdoğan (@ulerdogan), Doğan Alpaslan (@doganalpaslan)
discussions-to: https://ethereum-magicians.org/t/eip-7212-precompiled-for-secp256r1-curve-support/14789
status: Final
type: Standards Track
category: Core
created: 2023-06-22
---

## 개요

이 제안은 메시지 해시, 서명의 `r` 및 `s` 구성요소, 공개키의 `x` 및 `y` 좌표를 매개변수로 받아 "secp256r1" 타원 곡선에서 서명 검증을 수행하는 프리컴파일 컨트랙트를 생성합니다. 이를 통해 모든 EVM 체인(주로 이더리움 롤업)이 이 프리컴파일 컨트랙트를 쉽게 통합할 수 있습니다.

## 동기

"secp256r1" 타원 곡선은 NIST에서 표준화한 곡선으로, "ecrecover" 프리컴파일 컨트랙트에서 사용하는 "secp256k1" 타원 곡선과 다른 입력 매개변수로 동일한 계산을 수행합니다. 결합 공격 비용과 보안 조건은 두 곡선 모두 거의 동일합니다. "ecrecover"와 유사한 프리컴파일 컨트랙트를 추가하면 스마트 컨트랙트에서 "secp256r1" 타원 곡선을 사용한 서명 검증이 가능해지며, 다방면의 이점을 제공합니다. 중요한 요소 중 하나는 이 곡선이 Apple의 Secure Enclave, Webauthn, Android Keychain과 같은 많은 현대 기기에서 널리 사용되고 지원되어 사용자 채택이 입증되었다는 것입니다. 또한 이 프리컴파일 컨트랙트 도입은 모바일 기기에서 트랜잭션 서명을 통해 더 효율적이고 유연한 계정 관리를 가능하게 하는 계정 추상화에서 유용한 기능을 활성화할 수 있습니다.

대부분의 현대 기기와 애플리케이션은 "secp256r1" 타원 곡선에 의존합니다. 이 프리컴파일 컨트랙트의 추가로 기기 고유의 트랜잭션 서명 메커니즘 검증이 가능해집니다. 예를 들어:

1. **Apple의 Secure Enclave:** Apple 하드웨어에는 임의의 메시지에 서명할 수 있고 생체 인식으로만 접근 가능한 별도의 "신뢰 실행 환경"이 있습니다.
2. **Webauthn:** 웹 인증(WebAuthn)은 World Wide Web Consortium(W3C)에서 발행한 웹 표준입니다. WebAuthn은 공개키 암호화를 사용하여 웹 기반 애플리케이션 및 서비스에 사용자를 인증하기 위한 인터페이스 표준화를 목표로 합니다. 거의 모든 현대 웹 브라우저에서 사용되고 있습니다.
3. **Android Keystore:** Android Keystore는 개인키와 서명 방법을 관리하는 API입니다. Keystore를 애플리케이션의 서명 방법으로 사용할 때 개인키는 처리되지 않습니다. 또한 마이크로칩 내의 "신뢰 실행 환경"에서 수행될 수 있습니다.
4. **Passkeys:** Passkeys는 FIDO Alliance와 W3C 표준을 활용합니다. 비밀번호를 암호화 키 쌍으로 대체하며, 이는 타원 곡선 암호화에도 사용될 수 있습니다.

현대 기기에는 더 안전하게 설계된 이러한 서명 메커니즘이 있으며 트랜잭션 데이터에 서명할 수 있지만, 현재 지갑 중 이러한 서명 메커니즘을 활용하는 것은 없습니다. 따라서 제안된 프리컴파일 컨트랙트를 통해 이러한 안전한 서명 방법을 활성화하여 기기에서 기본적으로 트랜잭션을 시작하고 키 관리에도 사용할 수 있습니다. 이 제안은 키 관리를 위한 최대 보안과 편의성 달성을 목표로 합니다.

## 사양

이 문서의 핵심어 "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", "OPTIONAL"은 RFC 2119 및 RFC 8174에 설명된 대로 해석됩니다.

`FORK_TIMESTAMP`부터 통합 EVM 체인에서 `0x100`(0x0000000000000000000000000000000000000100)의 `PRECOMPILED_ADDRESS` 주소에 "secp256r1" 타원 곡선에서 서명 검증을 위한 프리컴파일 컨트랙트 `P256VERIFY`를 추가합니다.

### 타원 곡선 정보

"secp256r1"은 "P-256" 및 "prime256v1" 곡선으로도 알려진 특정 타원 곡선입니다. 곡선은 다음 방정식과 도메인 매개변수로 정의됩니다:

```
# 곡선: 짧은 바이어슈트라스 형식
y^2 ≡ x^3 + ax + b

# p: 곡선 소수 필드 모듈러스
0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff

# a: 타원 곡선 짧은 바이어슈트라스 첫 번째 계수
0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc

# b: 타원 곡선 짧은 바이어슈트라스 두 번째 계수
0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b

# G: 서브그룹의 기준점
(0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296,
 0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5)

# n: 서브그룹 차수 (점의 수)
0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551

# h: 서브그룹의 보조인자
0x1

```

### 타원 곡선 서명 검증 단계

서명 검증 알고리즘은 서명된 메시지 해시, "secp256r1" 곡선 알고리즘에서 제공하는 서명 구성요소, 서명자 개인키에서 파생된 공개키를 입력으로 받습니다. 검증은 다음 단계로 수행할 수 있습니다:

```
# h (메시지 해시)
# pubKey = (서명자 개인키의 공개키)

# 서명 증명의 모듈러 역원 계산:
s1 = s^(−1) (mod n)

# 서명 중 사용된 랜덤 포인트 복구:
R' = (h * s1) * G + (r * s1) * pubKey

# R'에서 x 좌표 추출:
r' = R'.x

# 다음을 비교하여 서명 검증 결과 계산:
r' == r

```

### 검증 시 필수 검사

프리컴파일 컨트랙트는 서명 구성요소가 유효한지 확인하기 위해 다음 요구사항을 **반드시** 검사해야 합니다:

- `r` 및 `s` 값이 `(0, n)` 범위 내(배타적)에 있는지 확인합니다. 여기서 `n`은 서브그룹의 차수입니다.
- `(x, y)`로 형성된 점이 곡선 위에 있고 `x`와 `y` 모두 `[0, p)` 범위 내(0 포함, p 배제)에 있는지 확인합니다. 여기서 `p`는 소수 필드 모듈러스입니다. 많은 구현에서 `(0, 0)`을 무한대 기준점으로 사용하는데, 이는 곡선 위에 있지 않으므로 거부되어야 합니다.

### 프리컴파일 컨트랙트 사양

`P256VERIFY` 프리컴파일 컨트랙트는 다음 입력 및 출력으로 제안됩니다(빅엔디안 값):

- **입력 데이터:** 다음을 포함하는 160바이트 데이터:
    - 서명된 데이터 `hash` 32바이트
    - 서명의 `r` 구성요소 32바이트
    - 서명의 `s` 구성요소 32바이트
    - 공개키의 `x` 좌표 32바이트
    - 공개키의 `y` 좌표 32바이트

- **출력 데이터:**
    - 서명 검증 프로세스가 성공하면 32바이트 형식으로 1을 반환합니다.
    - 서명 검증 프로세스가 실패하면 출력 데이터를 반환하지 않습니다.

### 프리컴파일 컨트랙트 가스 사용량

`P256VERIFY`의 서명 검증 비용은 `3450` 가스입니다. 다음 이유와 계산은 [근거](#근거) 및 [테스트 케이스](#테스트-케이스) 섹션에서 제공됩니다.

## 근거

"secp256r1" ECDSA 서명은 `v`, `r`, `s` 구성요소로 이루어집니다. `v` 값은 서명자의 공개키를 복구할 수 있게 하지만, 대부분의 서명자는 `r`과 `s`만으로 검증이 충분하기 때문에 서명의 `v` 구성요소를 생성하지 않습니다. 정확하고 더 호환 가능한 구현을 제공하기 위해 프리컴파일에서는 복구보다 검증이 선호됩니다.

기존 P256 구현은 `(x, y, r, s)`를 직접 검증합니다. 여기서도 이 스타일을 따르며, EVM을 위해 각 인수를 `uint256`으로 인코딩합니다.

이는 `ecrecover` 프리컴파일 주소 사양과 다릅니다. 장점은 1. NIST 사양(NIST FIPS 186-5 디지털 서명 표준(DSS)에 정의됨)을 따르고, 2. (대규모) P256 생태계의 나머지 부분과 일치하며, 가장 중요하게 3. 실행 클라이언트가 기존의 검증된 검증기 구현과 테스트 벡터를 사용할 수 있다는 것입니다.

또 다른 중요한 차이점은 NIST FIPS 186-5 사양에 가변성 검사가 포함되지 않는다는 것입니다. 대규모 기존 NIST P-256 생태계와의 호환성을 최대화하기 위해 여기서도 이를 맞췄습니다.

래퍼 라이브러리는 기본적으로 가변성 검사를 추가**해야 합니다(SHOULD)**. 원시 프리컴파일 호출(가변성 검사 없는 정확한 NIST FIPS 186-5 사양)을 래핑하는 함수는 명확히 식별되어야 합니다. 예를 들어, `P256.verifySignature`와 `P256.verifySignatureWithoutMalleabilityCheck`. 가변성 검사 추가는 간단하며 최소한의 가스 비용이 듭니다.

`PRECOMPILED_ADDRESS`는 `P256VERIFY`가 RIP로 제시된 첫 번째 프리컴파일 컨트랙트이고, 해당 주소가 RIP 프리컴파일용으로 예약된 프리컴파일 주소 집합에서 사용 가능한 첫 번째 주소이므로 `0x100`으로 선택되었습니다.

가스 비용은 `P256VERIFY`와 EVM의 `0x01` 주소에 구현된 `ECRECOVER` 프리컴파일 컨트랙트의 성능을 비교하여 제안되었습니다. "secp256r1" 서명 검증이 "secp256k1" 서명 복구보다 약 15% 느린 것으로 나타났으므로([테스트 케이스](#테스트-케이스)에서 자세히 설명), 두 프리컴파일 컨트랙트에서 유사한 "mgas/op" 값을 얻기 위해 비교를 통해 `3450` 가스가 제안되었습니다.

## 하위 호환성

프리컴파일 컨트랙트가 프리컴파일 주소 집합의 다음 사용 가능한 주소인 `PRECOMPILED_ADDRESS`에 추가되므로 하위 호환성 문제는 없습니다.

## 테스트 케이스

기능 테스트는 `P256VERIFY` 프리컴파일 컨트랙트의 [참조 구현](#참조-구현)에서 여러 케이스에 대해 적용되었으며 성공했습니다. 벤치마크 테스트도 [참조 구현](#참조-구현)에서 구현된 프리컴파일 컨트랙트의 "secp256r1" 서명 검증에 대한 의미 있는 가스 비용을 제안하기 위해 "go-ethereum"의 프리컴파일 테스트 구조에서 미리 계산된 데이터와 서명으로 `P256VERIFY`와 `ECRECOVER` 모두에 적용되었습니다. 자산의 예제 데이터로 벤치마크 테스트 결과를 확인할 수 있습니다:

- [P256Verify 벤치마크 테스트 결과](../assets/rip-7212/p256Verify_benchmark_test)
- [Ecrecover 벤치마크 테스트 결과](../assets/rip-7212/ecrecover_benchmark_test)

```
# geth 벤치마크 테스트 결과
# ECRECOVER 및 P256VERIFY (참조 구현)
# benchstat 도구 사용

goos: darwin
goarch: arm64
pkg: github.com/ethereum/go-ethereum/core/vm
                                            │ compare_p256Verify │ compare_ecrecover  │
                                            │       sec/op       │   sec/op           │
PrecompiledP256Verify/p256Verify-Gas=3450-8          57.75µ ± 1%
PrecompiledEcrecover/-Gas=3000-8                                   50.48µ ± 1%
geomean                                              57.75µ        50.48µ

                                            │ compare_p256Verify │ compare_ecrecover  │
                                            │       gas/op       │   gas/op           │
PrecompiledP256Verify/p256Verify-Gas=3450-8          3.450k ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   3.000k ± 0%
geomean                                              3.450k        3.000k

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │       mgas/s       │   mgas/s          │
PrecompiledP256Verify/p256Verify-Gas=3450-8           59.73 ± 1%
PrecompiledEcrecover/-Gas=3000-8                                   59.42 ± 1%
geomean                                               59.73        59.42

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │        B/op        │    B/op           │
PrecompiledP256Verify/p256Verify-Gas=3450-8         1.523Ki ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   800.0 ± 0%
geomean                                             1.523Ki        800.0

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │     allocs/op      │ allocs/op         │
PrecompiledP256Verify/p256Verify-Gas=3450-8           33.00 ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   7.000 ± 0%
geomean                                               33.00        7.000

```

## 참조 구현

`P256VERIFY` 프리컴파일 컨트랙트의 구현은 참조를 생성하기 위해 go-ethereum 클라이언트에 적용되었습니다. 또한 "secp256r1" 패키지는 Besu 클라이언트에서 사용하는 Besu Native 라이브러리에 이미 포함되어 있습니다. 다른 클라이언트 구현은 향후 로드맵에 있습니다.

## 보안 고려사항

변경 사항은 프로토콜 보안에 직접 영향을 미치지 않으며, 서명 검증을 위해 `P256VERIFY`를 사용하는 애플리케이션과 관련됩니다. "secp256r1" 곡선은 다른 많은 프로토콜과 서비스에서 사용되고 있으며 과거에 보안 문제가 없었습니다.


## 저작권

저작권 및 관련 권리는 [CC0](../LICENSE.md)를 통해 포기되었습니다.
